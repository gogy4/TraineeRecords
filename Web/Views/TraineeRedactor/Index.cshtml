@using Microsoft.AspNetCore.Mvc.TagHelpers
@model TraineeViewModel

@if (!string.IsNullOrEmpty(Model.Success))
{
    <div class="alert alert-success">@Model.Success</div>
}

@if (!string.IsNullOrEmpty(Model.Errors))
{
    <div class="alert alert-danger">@Model.Errors</div>
}

<h2>Редактировать информацию о стажере</h2>
<form asp-controller="TraineeRedactor" asp-action="Edit" method="post">
    <div class="form-group">
        <label for="Name">Имя</label>
        <input asp-for="Trainee.Name" class="form-control" id="Name"/>
    </div>

    <div class="form-group">
        <label for="Surname">Фамилия</label>
        <input asp-for="Trainee.Surname" class="form-control" id="Surname"/>
    </div>

    <div class="form-group">
        <label for="gender">Пол</label>
        <select asp-for="Trainee.Gender" id="gender" class="form-control">
            <option value="">Выберите пол</option>
            <option value="Мужской">Мужской</option>
            <option value="Женский">Женский</option>
        </select>
    </div>

    <div class="form-group">
        <label for="Email">Email</label>
        <input asp-for="Trainee.Email" class="form-control" id="Email"/>
    </div>

    <div class="form-group">
        <label for="PhoneNumber">Номер телефона</label>
        <input asp-for="Trainee.PhoneNumber" class="form-control" id="PhoneNumber"/>
    </div>

    <div class="form-group">
        <label for="DateOfBirth">Дата рождения</label>
        <input asp-for="Trainee.DateOfBirth" class="form-control" id="DateOfBirth" type="date"/>
    </div>

    <div class="form-group">
        <label for="internshipDirectionName">Направление стажировки</label>
        <select asp-for="Trainee.InternshipDirectionName" id="internshipDirectionName" class="form-control">
            <option value="">Выберите направление</option>
            @foreach (var direction in Model.InternshipDirections)
            {
                <option value="@direction">@direction</option>
            }
        </select>
        <input type="text" id="newInternshipDirectionName" class="form-control mt-2"
               placeholder="Добавить новое направление"/>
        <button type="button" id="addInternshipDirectionName" class="btn btn-success btn-sm mt-1">+</button>
    </div>

    <div class="form-group">
        <label for="currentProjectName">Текущий проект</label>
        <select asp-for="Trainee.CurrentProjectName" id="currentProjectName" class="form-control">
            <option value="">Выберите проект</option>
            @foreach (var project in Model.Projects)
            {
                <option value="@project">@project</option>
            }
        </select>
        <input type="text" id="newCurrentProjectName" class="form-control mt-2" placeholder="Добавить новый проект"/>
        <button type="button" id="addCurrentProjectName" class="btn btn-success btn-sm mt-1">+</button>
    </div>

    <input type="hidden" asp-for="Trainee.Id"/>

    <button type="submit" class="btn btn-primary">Сохранить изменения</button>
</form>

<script>
    async function postData(url, data) {
        let response = await fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });

        return response;
    }

    document.getElementById("addInternshipDirectionName").addEventListener("click", async function () {
        var newDirection = document.getElementById("newInternshipDirectionName").value.trim();
        if (newDirection) {
            let response = await postData('/CreateNewResource/AddInternshipDirection', newDirection);
            if (response.ok) {
                var select = document.getElementById("internshipDirectionName");
                var option = document.createElement("option");
                option.value = newDirection;
                option.textContent = newDirection;
                select.appendChild(option);
                select.value = newDirection;
                document.getElementById("newInternshipDirectionName").value = "";
            }
            else {
                try {
                    let errorText = await response.text();

                    let match = errorText.match(/System\.ArgumentException: (.+)/);
                    if (match && match[1]) {
                        errorText = match[1];
                    }

                    alert(errorText || "Ошибка при добавлении ресурса");
                } catch (e) {
                    alert("Ошибка при обработке ответа сервера");
                }
            }
        }
    });

    document.getElementById("addCurrentProjectName").addEventListener("click", async function () {
        var newProject = document.getElementById("newCurrentProjectName").value.trim();
        if (newProject) {
            let response = await postData('/CreateNewResource/AddCurrentProject', newProject);
            if (response.ok) {
                var select = document.getElementById("currentProjectName");
                var option = document.createElement("option");
                option.value = newProject;
                option.textContent = newProject;
                select.appendChild(option);
                select.value = newProject;
                document.getElementById("newCurrentProjectName").value = "";
            }
            else {
                try {
                    let errorText = await response.text();

                    let match = errorText.match(/System\.ArgumentException: (.+)/);
                    if (match && match[1]) {
                        errorText = match[1];
                    }

                    alert(errorText || "Ошибка при добавлении ресурса");
                } catch (e) {
                    alert("Ошибка при обработке ответа сервера");
                }
            }
        }
    });
</script>